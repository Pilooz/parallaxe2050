<!DOCTYPE html>
<html lang="fr">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <meta name="mobile-web-app-capable" content="yes">

        <title>Parallaxe :: Monitoring</title>
        <meta name="theme-color" content="#ffffff">

        <!-- <link href="/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet"> -->
        <link href="/bootswatch/dist/darkly/bootstrap.min.css" rel="stylesheet">

        <script src="/js/jquery.min.js"></script>    
        <script src="/socket.io/socket.io.js"></script>

        <script href="/bootstrap/dist/js/bootstrap.min.js"></script>

 <style>
    .AdminReseauBg, .BDDBg, .ComDigitaleBg, .CodeEtProgBg .HardwareBg{
        color:white;
    }

    .toolbar {
        /* margin-left:40%; */
        float:right;
    }

    .activityTitle {
        float:left;
    }

    .controlActivity, .controlActivity:hover {
        color:white;
    }

    /********* Popup de résultats OK/KO ************/
    .popupResult{
    margin: 10% auto;
    width : 30%;
    background-color: grey; /*rgb(243, 243, 243);*/
    padding: 1em;
    box-shadow: 0 15px 20px rgba(0, 0, 0, 0.3);
    border-radius: 5px;
    }

    .overlayResult {
    position: fixed;
    left: 0px;
    top:0px;
    background-color: rgba(0,0 ,0 , 0.5);
    width: 100%;
    height: 100%;
    z-index:1;
    display:none;
    }

    .btnClose {
        float: right;
        font-size:16pt;
        cursor: pointer;
        color: rgb(26, 26, 26);
    }

    #titleResult {
        width:100%;
        background-color: grey;
    }

    .colorBg {
        background-color: gray;
        margin-left: auto;
        margin-right: auto;
        margin-top: 2%;
        margin-bottom: 2%;
        text-align: center;
        vertical-align: center;
        width: 200px;
        min-height: 150px;
    }

    .card {
         margin-top: 10px;
     }

</style>
<body>
    <header>
      <div class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container d-flex justify-content-between">
          <a href="#" class="navbar-brand d-flex align-items-center">
            <strong>Parallaxe :: Monitoring</strong>
          </a>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
        </div>
      </div>
    </header>

<!-- Begin page content -->
<main role="main" class="container-fluid">

    <div id="overlayResult" class="overlayResult">
        <div id="popupResult" class="card popupResult mb-4">
            <h3 id="titleResult" class="card-header"><span id="title"></span><span id="btnClose" class="btnClose">&times;</span></h3>
            <div class="card-body">
                <h4 class="card-title">
                    <p id="messageResult" class="card-text"></p>
                </h4>
                
            </div>
        </div>
    </div>

    <div class="row">
        
        <div class="col-md-4">
            <div class="card mb-4 bg-light border-light shadow-sm">
                <h5 class="card-header">
                    <span class="activityTitle">Mode de jeu</span>
                </h5>
                <div class="card-body">
                    <p class="card-text">
                            <button type="button" id="classroomMode" class="btn btn-dark modeButton">Classe</button>
                            <div class="alert alert-primary" role="alert">
                                <em>Le container est paramétré pour une classe. Les session de jeu sont de 20 minutes.</em>
                            </div>

                            <button type="button" id="eventMode" class="btn btn-dark modeButton">Evenementiel</button>
                            <div class="alert alert-info" role="alert">
                                <em>Le container est en mode évenementiel, il est éventuellement ouvert, et les sessions de jeu sont de 40 minutes.</em>
                            </div>
                    </p>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card mb-8 bg-light border-light shadow-sm">
                <h5 class="card-header">
                    <span style="float:right;"><img src="/img/bootstrap-icons/stopwatch.svg" alt="" width="32" height="32" title="Chronomètre"></span>
                    <span class="activityTitle">Chronomètre</span>
                </h5>
                <div class="card-body">
                    <p class="card-text">
                        <iframe src="/timer" width="100%" height="250px"></iframe>
                        <a class="btn btn-default controlTimerBtn" id="reset" href="#"><img src="/img/bootstrap-icons/skip-start.svg" alt="" width="32" height="32" title="Reset"></a>&nbsp;
                        <a class="btn btn-default controlTimerBtn" id="stop" href="#"><img src="/img/bootstrap-icons/stop.svg" alt="" width="32" height="32" title="Stop"></a>&nbsp;
                        <a class="btn btn-default controlTimerBtn" id="start" href="#"><img src="/img/bootstrap-icons/caret-right.svg" alt="" width="32" height="32" title="Start"></a>&nbsp;
                    </p>

                </div>
            </div>
        </div>

    </div>

    <div class="row">
        <!-- Loop on each game  -->
<% data.global_config.servers.forEach(function(server) { %>
        <div class="col-md-4">
            <div id="<%= server.id %>" class="card mb-4 bg-light border-light shadow-sm">
                <h5 class="card-header">
                    <span class="activityTitle"><%= server.description %></span>
                    <span class="toolbar">
                        <a id="restart" href="#" class="controlActivity">
                            <svg  width="32" height="32" viewBox="0 0 16 16" class="bi bi-skip-start" fill="currentColor" xmlns="http://www.w3.org/2000/svg" title="Redémarrer l'activité">
                                <path fill-rule="evenodd" d="M4.5 3.5A.5.5 0 0 0 4 4v8a.5.5 0 0 0 1 0V4a.5.5 0 0 0-.5-.5z"/>
                                <path fill-rule="evenodd" d="M5.696 8L11.5 4.633v6.734L5.696 8zm-.792-.696a.802.802 0 0 0 0 1.392l6.363 3.692c.52.302 1.233-.043 1.233-.696V4.308c0-.653-.713-.998-1.233-.696L4.904 7.304z"/>
                            </svg>
                        </a>
                        <a id="nextStep" href="#" class="controlActivity">
                            <svg width="32" height="32" viewBox="0 0 16 16" class="bi bi-skip-forward" fill="currentColor" xmlns="http://www.w3.org/2000/svg" title="Passer à l'étape suivante">
                                <path fill-rule="evenodd" d="M15.5 3.5a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-1 0V8.752l-6.267 3.636c-.52.302-1.233-.043-1.233-.696v-2.94l-6.267 3.636C.713 12.69 0 12.345 0 11.692V4.308c0-.653.713-.998 1.233-.696L7.5 7.248v-2.94c0-.653.713-.998 1.233-.696L15 7.248V4a.5.5 0 0 1 .5-.5zM1 4.633v6.734L6.804 8 1 4.633zm7.5 0v6.734L14.304 8 8.5 4.633z"/>
                            </svg>  
                        </a>
                    </span>
                </h5>
                <div class="card-body">
                    <p class="card-text">
                        <table class="table table-hover">
                            <tr>
                                <th scope="col">
                                    <img src="/img/bootstrap-icons/tag.svg" alt="" width="32" height="32" title="Dernier badge RFID lu">
                                </th>
                                <td>    
                                    <h4>
                                        <code id="rfidcode"></code>&nbsp;
                                        <img src="/img/bootstrap-icons/arrow-right.svg" alt="" width="32" height="32" title="">&nbsp;
                                        <span class="badge badge-pill badge-warning" id="groupcode"></span>
                                </h4>
                                </td>
                            </tr>
                            <tr>
                                <th scope="col">
                                    <img src="/img/bootstrap-icons/list-stars.svg" alt="" width="32" height="32" title="Etape courante">
                                </th>
                                <td>
                                    <h4><span class="badge badge-pill badge-success" id="stepId"></span><span class="badge badge-pill badge-default" id="totalsteps"></span></h4>
                                </td>
                            </tr>
                            <tr>
                                <th scope="col">
                                    <img src="/img/bootstrap-icons/puzzle.svg" alt="" width="32" height="32" title="Solutions">
                                </th>
                                <td>
                                    <pre><code id="solutions"></code></pre>
                                </td>
                            </tr>
                        </table>
                    </p>

                    <!-- <div class="d-flex flex-row-reverse">
                    <p class="text-muted">Activité en cours depuis  9 mins</p>
                    </div> -->
                </div>
            </div>
        </div>
<% }) %>
    </div>

    <div class="row">
        <!-- Games metrics -->
        <div class="col-md-12">
            <div class="card mb-12 border-light shadow-sm">
                <h5 class="card-header metrics">
                    <img src="/img/bootstrap-icons/bar-chart-line-fill.svg" alt="" width="32" height="32" title="Bootstrap">&nbsp;&nbsp;&nbsp;
                    Statistiques globales
                </h5>
                <div class="card-body">

                    <table class="table table-hover">
                        <thead>
                          <tr>
                            <th scope="col"><img src="/img/bootstrap-icons/laptop.svg" alt="" width="32" height="32" title="Dispositif"></th>
                            <th scope="col"><img src="/img/bootstrap-icons/tags.svg" alt="" width="32" height="32" title="Nombre de lectures RFID"></th>
                            <th scope="col">
                                <img src="/img/bootstrap-icons/chat-dots.svg" alt="" width="32" height="32" title="Nombre de messages adruino/Ordi échangés">
                                <img src="/img/bootstrap-icons/chat-right-dots.svg" alt="" width="32" height="32" title="">
                            </th>
                            <th scope="col"><img src="/img/bootstrap-icons/clock-history.svg" alt="" width="32" height="32" title="Temps total de jeu">
                            </th>
                          </tr>
                        </thead>
                        <tbody>
                            <!-- Loop on each game -->
<% data.global_config.servers.forEach(function(server) { %>
                        <tr>
                            <th scope="row"><a href="http://<%= server.ip %>:<%= server.port %>/" target="_blank"><%= server.description %></a></th>
                            <td>125</td>
                            <td>3289</td>
                            <td>2:10:00</td>
                        </tr>
<% }) %>
                        </tbody>
                      </table>                    
                    
                </div>
            </div>
        </div>

    </div>

</main>

<footer class="footer mt-auto py-3">
  <!-- <div class="container">
    <span class="text-muted">Ici le footer</span>
  </div> -->
</footer>
<script>
     $(document).ready(function() {
        // Socket for timer control 
        var socket_timer = io('http://<%= data.global_config.app.adminServerIp %>:<%= data.global_config.app.adminServerPort %>/timercontrol');

        var popup = $("#overlayResult");
        var header = $("#popupResult")
        var title = $("#titleResult #title");
        var msg = $("#messageResult");

        function initPopup() {
            popup.attr('style', 'display:none');
            header.removeClass("border-success").addClass("border-danger");
            title.html("Erreur !");
            msg.html("Quelque chose ne s'est pas bien passé. <br/>La requête n'a pas abouti. Cette activité est-elle allumé ? Connectée au réseau ?");
        }

		// Listener sur le bouton de fermeture de la popup
		$("#overlayResult").on('click', function(){
			$("#overlayResult").attr('style', 'display:none');
        });
        
        // Listener sur les boutons de mode de jeu
        $(".modeButton").on('click', function() {
            var mode = this.id;
            setGameMode(mode);
        });

        // Listener sur les controles du timer
        $(".controlTimerBtn").on('click', function(e) {
            var action = this.id;
            var gameMode = "classroom";
            console.log('action = '+action);

            socket_timer.emit('toserver.timerControl',  { action: action, gameMode: gameMode } );
        });

        // Set game mode on server and on all activities
        function setGameMode(mode) {

        }

        // loop on each game
        // [ ->

<% data.global_config.servers.forEach(function(server) { %>

        var socket_<%= server.id %> = io('http://<%= server.ip %>:<%= server.port %>/monitoring');
        var nextStep_<%= server.id %> = "";
        // ------------------------------------------------------------------
        // Socket listening
        // ------------------------------------------------------------------

        // Receiving new rfid badge
        socket_<%= server.id %>.on('toclient.newGameSession_<%= server.id %>', function(data) {
            $("#<%= server.id %> #rfidcode").html(data.tag);
            $("#<%= server.id %> #groupcode").html(data.group);
        });

        // Receiving Current Step of game
        socket_<%= server.id %>.on('toclient.newGameStep_<%= server.id %>', function(data) {
            $("#<%= server.id %> #stepId").html(data.stepId);
            $("#<%= server.id %> #totalsteps").html(data.totalSteps + " étapes au total.");
        });

        // receiving solutions for current step
        socket_<%= server.id %>.on('toclient.solutionsForStep_<%= server.id %>', function(data) {
            var soluce = data.solutions[0].responses;
            nextStep_<%= server.id %> = data.nextStep;
            if (soluce.length == 0) soluce = "Pas de solution pour cette étape.";
            else soluce = JSON.stringify(soluce, null, 4);
            $("#<%= server.id %> #solutions").html(soluce);
        });

        // Lights control and color data
        socket_<%= server.id %>.on('toclient.colorsSets_<%= server.id %>', function(data) {
            data.colorsSet.forEach(function(c){
                var RGBcolors = "rgb("+c.rgb[0]+", "+c.rgb[1]+", "+c.rgb[2]+");";
                $("#"+c.scenarioId + " .card-header").attr("style", "background-color: "+RGBcolors+";" );
            });
        });

        //
        // Activity controls  : Restart / nextStep
        //
        $("#<%= server.id %> #restart").on('click', function(e) {
            initPopup();
            $.get( "http://<%= server.ip %>:<%= server.port %>/api/restart", function(data) {
                if (data.status == "200") {
                    header.removeClass("border-danger");
                    header.addClass("border-success");
                    title.html("Ok !");
                    msg.html(data.message);
                }
            });
            popup.attr('style', 'display:block');
            e.preventDefault();
        });

        //
        // nextStep
        //
        $("#<%= server.id %> #nextStep").on('click', function(e) {
            initPopup();
            $.get( "http://<%= server.ip %>:<%= server.port %>/api/nextStep", function(data) {
                if (data.status == "200") {
                    header.removeClass("border-danger");
                    header.addClass("border-success");
                    title.html("Ok !");
                    msg.html(data.message);
                }
            });
            popup.attr('style', 'display:block');
            e.preventDefault();
        });

<% }) %>
        // <- ]
        // end loop

    initPopup();
}); 
</script>
<!-- <%- JSON.stringify(data, null, 1) %>-->
</body>
</html>